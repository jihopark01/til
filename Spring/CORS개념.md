# CORS

### CORS란?

교차 출처 리소스 공유(Cross-Origin Resource Sharing, CORS)는 추가 HTTP 헤더를 사용하여, 한 출처에서 실행 중인 웹 애플리케이션이 다른 출처(프로토콜, 도메인, 포트번호)의 리소스에 접근할 수 있는 권한을 부여하도록 브라우저에 알려주는 체제 , 웹 애플리케이션은 리소스가 자신의 출처와 다를 때 교차 출처 HTTP요청을 실행

도메인, 프로토콜, 포트 번호가 하나라도 다를 경우에 출처가 다른 교차 출처라고 판단되며 브라우저에서는 보안 때문에 Cross-Origin HTTP 요청을 제한한다, 권한 부여를 위한 Cross-Origin 요청은 서버에서 허가를 받아야 하는데, HTTP-header를 통해서 받을 수 있다.

출처를 비교하는 방법: URL 구성 요소 중 프로토콜, 호스트, 포트 세 가지만 동일한지 확인하면 된다. 같은 프로토콜, 호스트, 포트를 사용한다면 같은 출처로 인정되며 , 리소스가 자신의 출처와 다를 경우 브라우저는 교차 출처 요청을 실행한다. 한 마디로 세 가지가 모두 일치하면 Same Origin이며 , 하나라도 일치하지 않는다면 Cross-Origin이 된다.


---

### CORS가 필요한 이유

출처가 다른 두 개의 어플리케이션이 마음대로 소통하는 환경은 위험하다. 웹에서 돌아가는 클라이언트 어플리케이션은 사용자 공격에 취약한데 그 예로 개발자 도구만 열면 DOM, JavaScript 코드 등 각종 통신 정보를 쉽게 열람할 수 있는데 이를 통해 사용자가 악의적으로 본 사이트를 모방할 수 있는 점이 있다. 이렇게 다른 출처의 어플리케이션이 통신하는 것에 아무런 제한이 없다면 사용자의 정보 탈취가 쉬워진다.

---

### SOP(Same-Origin-Policy, 동일 출처 정책)란?

웹에서는 SOP, CORS 두 가지 정책이 있는데 SOP는 같은 출처에서만 리소스를 공유할 수 있다는 규칙을 가진 정책이다.

브라우저에서 API를 호출할 때 CORS policy 오류가 발생할 경우가 있는데 그 이유는 브라우저가 동일 출처 정책을 지키고 있기 때문에 다른 출처의 리소스 접근을 금지하고 있기 때문이다.

---

### CORS의 동작 원리

웹 애플리케이션이 다른 출처의 리소스에 접근할 때 HTTP header에 요청을 보낸다고 했는데 HTTP 프로토콜을 사용하여 요청을 보내며 , 요청 헤더의 Origin 필드에 요청을 보내는 출처를 담아서 보낸다. 서버가 이 요청에 대한 응답을 할 때 응답 헤더의 Access-Control-Allow-Origin 이라는 값에 리소스 접근 허가가 내려진 출처를 내려주고 , 응답을 받은 브라우저는 자신이 보낸 Origin과 서버가 보내준 응답인 Access-Control-Allow-Origin을 비교하고 유효한 응답인지 확인하고 만약 유효하지 않다면 그 응답을 사용하지 않는다.

---

### CORS의 세 가지 경우

- Preflight Request

일반적으로 웹 어플리케이션을 개발할 때 가장 많이 사용하는 케이스로이 때 브라우저는 요청을 한 번에 보내지 않고 예비 요청과 본 요청으로 나눠서 서버로 전송한다.



본 요청을 보내기 전에 보내는 예비 요청을 Preflight라고 하며, 예비 요청에는 OPTIONS 메소드가 사용된다.

fetch API를 이용해 브라우저에 리소스를 받아오는 명령을 내리면 브라우저는 서버에게 예비 요청을 먼저 보낸다. 서버는 예비 요청 응답으로 현재 어떤 것을 허용하고, 어떤 것을 금지하고 있는 지에 대한 정보를 응답 헤더에 담아서 브라우저에게 다시 보내준다.

이후 브라우저는 자신이 보낸 예비 요청과 서버가 응답에 담아준 내용인 정책을 비교하여 안전하다고 판단되면 같은 엔드포인트로 다시 본 요청을 보내게 되고 서버가 본 요청에 대한 응답을 하면 브라우저는 최종적으로 응답 데이터를 자바스크립트에 넘겨준다.

- Simple Request

단순 요청은 예비 요청 없이 서버에 본 요청을 보낸 후, 서버가 응답 헤더에 Access-Control-Allow-Origin과 같은 값을 보내면 그 때 브라우저가 CORS 정책 위반 여부를 검사하는 방식이다.



예비 요청을 생략할 수 있는 Simple Request는 특정 조건을 만족해야한다.

 - 요청 메소드는 GET, HEAD, POST 중 하나여야 하고
 - Accept, Accept-Language, Content-Language, Content-type, DPR, Downlink, Save-Data, Viewport-Width, Width를 제외한 헤더를 사용하면 안된다.
 - Credentialed Request

인증된 요청을 사용하는 방법으로 CORS 기본적인 방식보다는 다른 출처 간 통신에서 보안을 조금 더 강화하고 싶을 때 사용하는 방법이다.  XMLHttpRequest객체나 fetch API는 별도의 옵션 없이 브라우저의 쿠키 정보나 인증과 관련된 헤더를 요청에 담지 않는다.  이때 요청에 인증 관련 정보를 담을 수 있게 해주는 옵션이 바로 credentials 옵션이다.

이 옵션에는 3가지의 값을 사용 가능하다.

| 옵션 값 | description |
| --- | --- |
| same-origin(default) | 같은 출처 간 요청에만 인증 정보를 담을 수 있다 |
| include | 모든 요청에 인증 정보를 담을 수 있다 |
| omit | 모든 요청에 인증 정보를 담지 않는다 |

만약 same-origin 이나 include와 같은 옵션 사용해 리소스 요청에 인증 정보가 포함되면 , 브라우저는 Cross-Origin 리소스를 요청 시에 Access-Control-Allow-Origin뿐만 아니라 추가적인 검사 조건을 갖출 수 있다.

---

### CORS 해결

- Access-Control-Allow-Origin 세팅

가장 대표적인 방법은 서버에서 Access-Control-Allow-Origin 헤더에 적절한 값을 설정하는 방법이다.

```jsx
Access-Control-Allow-Origin: https://google.com
```